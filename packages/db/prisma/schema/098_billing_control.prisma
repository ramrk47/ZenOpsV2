model BillingAccount {
  id                      String          @id @default(uuid()) @db.Uuid
  tenantId                String          @map("tenant_id") @db.Uuid
  accountType             BillingAccountType @map("account_type")
  externalKey             String          @map("external_key")
  displayName             String          @map("display_name")
  status                  BillingAccountStatus @default(active)
  defaultPaymentTermsDays Int             @default(15) @map("default_payment_terms_days")
  createdAt               DateTime        @default(now()) @map("created_at")
  updatedAt               DateTime        @updatedAt @map("updated_at")
  policy                  BillingPolicy?
  subscriptions           BillingSubscription[]
  creditReservations      BillingCreditReservation[]
  creditLedger            BillingCreditLedger[]
  creditBalance           BillingCreditBalance?
  usageEvents             BillingUsageEvent[]
  paymentCustomers        PaymentCustomer[]
  paymentOrders           PaymentOrder[]
  paymentEvents           PaymentEvent[]
  serviceInvoices         ServiceInvoice[]
  serviceInvoiceSequences ServiceInvoiceSequence[]
  serviceIdempotencyKeys  ServiceIdempotencyKey[]

  @@unique([externalKey])
  @@index([tenantId, accountType, status])
  @@map("billing_accounts")
}

model BillingCreditBalance {
  id               String         @id @default(uuid()) @db.Uuid
  tenantId         String         @map("tenant_id") @db.Uuid
  accountId        String         @unique @map("account_id") @db.Uuid
  walletBalance    Int            @default(0) @map("wallet_balance")
  reservedBalance  Int            @default(0) @map("reserved_balance")
  availableBalance Int            @default(0) @map("available_balance")
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  account          BillingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([tenantId, accountId])
  @@map("billing_credit_balances")
}

model BillingPolicy {
  id               String          @id @default(uuid()) @db.Uuid
  tenantId         String          @map("tenant_id") @db.Uuid
  accountId        String          @unique @map("account_id") @db.Uuid
  billingMode      BillingMode     @default(postpaid) @map("billing_mode")
  paymentTermsDays Int             @default(15) @map("payment_terms_days")
  creditCostModel  CreditCostModel @default(flat) @map("credit_cost_model")
  currency         String          @default("INR")
  isEnabled        Boolean         @default(true) @map("is_enabled")
  createdAt        DateTime        @default(now()) @map("created_at")
  updatedAt        DateTime        @updatedAt @map("updated_at")
  account          BillingAccount  @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([tenantId, billingMode, isEnabled])
  @@index([billingMode, isEnabled])
  @@map("billing_policies")
}

model BillingPlanCatalog {
  id                    String                @id @default(uuid()) @db.Uuid
  name                  String
  currency              String                @default("INR")
  priceMonthly          Decimal               @default(0) @db.Decimal(14, 2) @map("price_monthly")
  cycleDays             Int                   @default(30) @map("cycle_days")
  monthlyCreditAllowance Int?                @map("monthly_credit_allowance")
  isActive              Boolean               @default(true) @map("is_active")
  createdAt             DateTime              @default(now()) @map("created_at")
  updatedAt             DateTime              @updatedAt @map("updated_at")
  subscriptions         BillingSubscription[]

  @@map("billing_plan_catalog")
}

model BillingSubscription {
  id           String                    @id @default(uuid()) @db.Uuid
  tenantId     String                    @map("tenant_id") @db.Uuid
  accountId    String                    @map("account_id") @db.Uuid
  planId       String                    @map("plan_id") @db.Uuid
  status       BillingSubscriptionStatus @default(active)
  startsAt     DateTime                  @default(now()) @map("starts_at")
  endsAt       DateTime?                 @map("ends_at")
  currentPeriodStart DateTime?           @map("current_period_start")
  currentPeriodEnd DateTime?             @map("current_period_end")
  nextRefillAt DateTime?                 @map("next_refill_at")
  lastRefilledAt DateTime?               @map("last_refilled_at")
  graceUntil DateTime?                   @map("grace_until")
  lastPaymentAt DateTime?                @map("last_payment_at")
  externalProvider String?               @map("external_provider")
  externalSubscriptionId String?         @map("external_subscription_id")
  createdAt    DateTime                  @default(now()) @map("created_at")
  updatedAt    DateTime                  @updatedAt @map("updated_at")
  account      BillingAccount            @relation(fields: [accountId], references: [id], onDelete: Cascade)
  plan         BillingPlanCatalog        @relation(fields: [planId], references: [id], onDelete: Cascade)
  events       BillingSubscriptionEvent[]

  @@index([tenantId, accountId, status])
  @@index([accountId, status])
  @@index([planId, status])
  @@index([tenantId, nextRefillAt, status])
  @@index([externalProvider, externalSubscriptionId])
  @@map("billing_subscriptions")
}

model BillingSubscriptionEvent {
  id             String                @id @default(uuid()) @db.Uuid
  tenantId       String                @map("tenant_id") @db.Uuid
  subscriptionId String?               @map("subscription_id") @db.Uuid
  provider       String
  eventType      String                @map("event_type")
  signatureOk    Boolean?              @map("signature_ok")
  payloadHash    String?               @map("payload_hash")
  receivedAt     DateTime?             @map("received_at")
  processedAt    DateTime?             @map("processed_at")
  payloadJson    Json                  @default("{}") @db.JsonB @map("payload_json")
  idempotencyKey String                @map("idempotency_key")
  createdAt      DateTime              @default(now()) @map("created_at")
  subscription   BillingSubscription?  @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@unique([provider, idempotencyKey])
  @@index([tenantId, subscriptionId, createdAt])
  @@map("billing_subscription_events")
}

model BillingCreditReservation {
  id             String                 @id @default(uuid()) @db.Uuid
  tenantId       String                 @map("tenant_id") @db.Uuid
  accountId      String                 @map("account_id") @db.Uuid
  refType        String                 @map("ref_type")
  refId          String                 @map("ref_id")
  amount         Int                    @default(1)
  status         CreditReservationStatus @default(active)
  idempotencyKey String                 @map("idempotency_key")
  expiresAt      DateTime?              @map("expires_at")
  consumedAt     DateTime?              @map("consumed_at")
  releasedAt     DateTime?              @map("released_at")
  createdAt      DateTime               @default(now()) @map("created_at")
  updatedAt      DateTime               @updatedAt @map("updated_at")
  account        BillingAccount         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  ledgerEntries  BillingCreditLedger[]

  @@unique([accountId, idempotencyKey])
  @@index([tenantId, accountId, status, createdAt])
  @@index([accountId, refType, refId])
  @@index([status, expiresAt])
  @@map("billing_credit_reservations")
}

model PaymentCustomer {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  accountId       String         @map("account_id") @db.Uuid
  provider        PaymentProvider
  providerCustomerId String      @map("provider_customer_id")
  metadataJson    Json           @default("{}") @db.JsonB @map("metadata_json")
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  account         BillingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, provider])
  @@unique([provider, providerCustomerId])
  @@index([tenantId, provider])
  @@map("payment_customers")
}

model PaymentOrder {
  id              String               @id @default(uuid()) @db.Uuid
  tenantId        String               @map("tenant_id") @db.Uuid
  accountId       String               @map("account_id") @db.Uuid
  provider        PaymentProvider
  purpose         PaymentPurpose
  status          PaymentObjectStatus  @default(pending)
  amount          Decimal              @db.Decimal(14, 2)
  currency        String               @default("INR")
  creditsAmount   Int?                 @map("credits_amount")
  refType         String?              @map("ref_type")
  refId           String?              @map("ref_id")
  idempotencyKey  String               @map("idempotency_key")
  providerCustomerId String?           @map("provider_customer_id")
  providerOrderId String?              @map("provider_order_id")
  providerPaymentId String?            @map("provider_payment_id")
  checkoutUrl     String?              @map("checkout_url")
  serviceInvoiceId String?             @map("service_invoice_id") @db.Uuid
  settledAt       DateTime?            @map("settled_at")
  metadataJson    Json                 @default("{}") @db.JsonB @map("metadata_json")
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  account         BillingAccount       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  serviceInvoice  ServiceInvoice?      @relation(fields: [serviceInvoiceId], references: [id], onDelete: SetNull)
  events          PaymentEvent[]
  invoiceLinks    InvoicePaymentLink[]

  @@unique([provider, idempotencyKey])
  @@index([tenantId, accountId, status, createdAt])
  @@index([provider, providerOrderId])
  @@index([provider, providerPaymentId])
  @@map("payment_orders")
}

model PaymentEvent {
  id              String              @id @default(uuid()) @db.Uuid
  tenantId        String              @map("tenant_id") @db.Uuid
  accountId       String?             @map("account_id") @db.Uuid
  paymentOrderId  String?             @map("payment_order_id") @db.Uuid
  serviceInvoiceId String?            @map("service_invoice_id") @db.Uuid
  provider        PaymentProvider
  eventId         String              @map("event_id")
  eventType       String              @map("event_type")
  idempotencyKey  String?             @map("idempotency_key")
  signatureOk     Boolean             @default(false) @map("signature_ok")
  payloadHash     String              @map("payload_hash")
  payloadJson     Json                @default("{}") @db.JsonB @map("payload_json")
  receivedAt      DateTime            @default(now()) @map("received_at")
  processedAt     DateTime?           @map("processed_at")
  createdAt       DateTime            @default(now()) @map("created_at")
  updatedAt       DateTime            @updatedAt @map("updated_at")
  account         BillingAccount?     @relation(fields: [accountId], references: [id], onDelete: SetNull)
  paymentOrder    PaymentOrder?       @relation(fields: [paymentOrderId], references: [id], onDelete: SetNull)
  serviceInvoice  ServiceInvoice?     @relation(fields: [serviceInvoiceId], references: [id], onDelete: SetNull)

  @@unique([provider, eventId])
  @@unique([provider, idempotencyKey])
  @@index([tenantId, provider, receivedAt])
  @@index([paymentOrderId])
  @@map("payment_events")
}

model InvoicePaymentLink {
  id             String               @id @default(uuid()) @db.Uuid
  tenantId       String               @map("tenant_id") @db.Uuid
  serviceInvoiceId String             @map("service_invoice_id") @db.Uuid
  paymentOrderId String               @map("payment_order_id") @db.Uuid
  provider       PaymentProvider
  purpose        PaymentPurpose
  status         PaymentObjectStatus  @default(pending)
  amount         Decimal              @db.Decimal(14, 2)
  currency       String               @default("INR")
  checkoutUrl    String?              @map("checkout_url")
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  serviceInvoice ServiceInvoice       @relation(fields: [serviceInvoiceId], references: [id], onDelete: Cascade)
  paymentOrder   PaymentOrder         @relation(fields: [paymentOrderId], references: [id], onDelete: Cascade)

  @@unique([serviceInvoiceId, paymentOrderId])
  @@index([tenantId, serviceInvoiceId, status, createdAt])
  @@map("invoice_payment_links")
}

model BillingCreditLedger {
  id             String                 @id @default(uuid()) @db.Uuid
  tenantId       String                 @map("tenant_id") @db.Uuid
  accountId      String                 @map("account_id") @db.Uuid
  reservationId  String?                @map("reservation_id") @db.Uuid
  delta          Int
  reason         CreditLedgerReason
  refType        String?                @map("ref_type")
  refId          String?                @map("ref_id")
  idempotencyKey String                 @map("idempotency_key")
  metadataJson   Json                   @default("{}") @db.JsonB @map("metadata_json")
  createdAt      DateTime               @default(now()) @map("created_at")
  account        BillingAccount         @relation(fields: [accountId], references: [id], onDelete: Cascade)
  reservation    BillingCreditReservation? @relation(fields: [reservationId], references: [id], onDelete: SetNull)

  @@unique([accountId, idempotencyKey])
  @@index([tenantId, accountId, createdAt])
  @@index([reservationId])
  @@map("billing_credit_ledger")
}

model BillingUsageEvent {
  id               String                 @id @default(uuid()) @db.Uuid
  tenantId         String                 @map("tenant_id") @db.Uuid
  sourceSystem     BillingUsageSourceSystem @map("source_system")
  eventType        String                 @map("event_type")
  accountId        String?                @map("account_id") @db.Uuid
  externalAccountKey String?              @map("external_account_key")
  payloadJson      Json                   @default("{}") @db.JsonB @map("payload_json")
  idempotencyKey   String                 @map("idempotency_key")
  createdAt        DateTime               @default(now()) @map("created_at")
  updatedAt        DateTime               @updatedAt @map("updated_at")
  account          BillingAccount?        @relation(fields: [accountId], references: [id], onDelete: SetNull)

  @@unique([sourceSystem, idempotencyKey])
  @@index([tenantId, accountId, createdAt])
  @@index([externalAccountKey, createdAt])
  @@map("billing_usage_events")
}

model ServiceInvoiceSequence {
  id            String    @id @default(uuid()) @db.Uuid
  tenantId      String    @map("tenant_id") @db.Uuid
  accountId     String    @map("account_id") @db.Uuid
  financialYear String    @map("financial_year")
  lastNumber    Int       @default(0) @map("last_number")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")
  account       BillingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([tenantId, accountId, financialYear])
  @@map("service_invoice_sequences")
}

model ServiceInvoice {
  id              String               @id @default(uuid()) @db.Uuid
  tenantId        String               @map("tenant_id") @db.Uuid
  accountId       String               @map("account_id") @db.Uuid
  assignmentId    String?              @map("assignment_id") @db.Uuid
  channelRequestId String?             @map("channel_request_id") @db.Uuid
  invoiceNumber   String?              @map("invoice_number")
  status          ServiceInvoiceStatus @default(draft)
  issuedDate      DateTime?            @db.Date @map("issued_date")
  dueDate         DateTime?            @db.Date @map("due_date")
  sentAt          DateTime?            @map("sent_at")
  currency        String               @default("INR")
  subtotalAmount  Decimal              @default(0) @db.Decimal(14, 2) @map("subtotal_amount")
  taxAmount       Decimal              @default(0) @db.Decimal(14, 2) @map("tax_amount")
  totalAmount     Decimal              @default(0) @db.Decimal(14, 2) @map("total_amount")
  amountPaid      Decimal              @default(0) @db.Decimal(14, 2) @map("amount_paid")
  amountDue       Decimal              @default(0) @db.Decimal(14, 2) @map("amount_due")
  amountCredited  Decimal              @default(0) @db.Decimal(14, 2) @map("amount_credited")
  isPaid          Boolean              @default(false) @map("is_paid")
  paidAt          DateTime?            @map("paid_at")
  voidedAt        DateTime?            @map("voided_at")
  voidReason      String?              @map("void_reason")
  billToName      String?              @map("bill_to_name")
  billToAddress   String?              @map("bill_to_address")
  notes           String?
  pdfStorageKey   String?              @map("pdf_storage_key")
  createdByUserId String?              @map("created_by_user_id") @db.Uuid
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
  account         BillingAccount       @relation(fields: [accountId], references: [id], onDelete: Restrict)
  paymentEvents   PaymentEvent[]
  paymentOrders   PaymentOrder[]
  paymentLinks    InvoicePaymentLink[]
  items           ServiceInvoiceItem[]
  payments        ServiceInvoicePayment[]
  adjustments     ServiceInvoiceAdjustment[]
  attachments     ServiceInvoiceAttachment[]
  auditLogs       ServiceInvoiceAuditLog[]

  @@unique([tenantId, invoiceNumber])
  @@index([tenantId, status])
  @@index([accountId, status])
  @@index([assignmentId])
  @@index([channelRequestId])
  @@map("service_invoices")
}

model ServiceInvoiceItem {
  id          String         @id @default(uuid()) @db.Uuid
  tenantId    String         @map("tenant_id") @db.Uuid
  invoiceId   String         @map("invoice_id") @db.Uuid
  description String
  quantity    Decimal        @default(1) @db.Decimal(12, 2)
  unitPrice   Decimal        @default(0) @db.Decimal(14, 2) @map("unit_price")
  lineTotal   Decimal        @default(0) @db.Decimal(14, 2) @map("line_total")
  taxCode     String?        @map("tax_code")
  taxRate     Decimal?       @db.Decimal(8, 4) @map("tax_rate")
  serviceCode String?        @map("service_code")
  orderIndex  Int            @default(0) @map("order_index")
  createdAt   DateTime       @default(now()) @map("created_at")
  updatedAt   DateTime       @updatedAt @map("updated_at")
  invoice     ServiceInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId, orderIndex])
  @@map("service_invoice_items")
}

model ServiceInvoicePayment {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  invoiceId       String         @map("invoice_id") @db.Uuid
  amount          Decimal        @db.Decimal(14, 2)
  paidAt          DateTime       @default(now()) @map("paid_at")
  mode            String         @default("manual")
  reference       String?
  notes           String?
  createdByUserId String?        @map("created_by_user_id") @db.Uuid
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  invoice         ServiceInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId, paidAt])
  @@map("service_invoice_payments")
}

model ServiceInvoiceAdjustment {
  id              String         @id @default(uuid()) @db.Uuid
  tenantId        String         @map("tenant_id") @db.Uuid
  invoiceId       String         @map("invoice_id") @db.Uuid
  amount          Decimal        @db.Decimal(14, 2)
  adjustmentType  String         @map("adjustment_type")
  reason          String?
  issuedAt        DateTime       @default(now()) @map("issued_at")
  createdByUserId String?        @map("created_by_user_id") @db.Uuid
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
  invoice         ServiceInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId, issuedAt])
  @@map("service_invoice_adjustments")
}

model ServiceInvoiceAttachment {
  id           String                      @id @default(uuid()) @db.Uuid
  tenantId     String                      @map("tenant_id") @db.Uuid
  invoiceId    String                      @map("invoice_id") @db.Uuid
  kind         ServiceInvoiceAttachmentKind @default(other)
  originalName String                      @map("original_name")
  storageKey   String                      @map("storage_key")
  mimeType     String?                     @map("mime_type")
  sizeBytes    BigInt                      @default(0) @db.BigInt @map("size_bytes")
  uploadedByUserId String?                 @map("uploaded_by_user_id") @db.Uuid
  createdAt    DateTime                    @default(now()) @map("created_at")
  updatedAt    DateTime                    @updatedAt @map("updated_at")
  invoice      ServiceInvoice              @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId, kind, createdAt])
  @@map("service_invoice_attachments")
}

model ServiceInvoiceAuditLog {
  id          String         @id @default(uuid()) @db.Uuid
  tenantId    String         @map("tenant_id") @db.Uuid
  invoiceId   String         @map("invoice_id") @db.Uuid
  eventType   String         @map("event_type")
  actorUserId String?        @map("actor_user_id") @db.Uuid
  diffJson    Json           @default("{}") @db.JsonB @map("diff_json")
  createdAt   DateTime       @default(now()) @map("created_at")
  invoice     ServiceInvoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)

  @@index([tenantId, invoiceId, createdAt])
  @@map("service_invoice_audit_logs")
}

model ServiceIdempotencyKey {
  id             String         @id @default(uuid()) @db.Uuid
  tenantId       String         @map("tenant_id") @db.Uuid
  accountId      String         @map("account_id") @db.Uuid
  scope          String
  key            String
  requestHash    String         @map("request_hash")
  responseJson   Json?          @map("response_json")
  createdAt      DateTime       @default(now()) @map("created_at")
  account        BillingAccount @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, scope, key])
  @@index([tenantId, accountId, createdAt])
  @@map("service_idempotency_keys")
}
