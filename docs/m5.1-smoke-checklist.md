# M5.1 Smoke Checklist

## Identity and Routing
- `curl -fsS https://api.<domain>/v1/meta`
- `curl -fsS https://api.<domain>/v1/health`
- `curl -fsS https://api-v1.<domain>/v1/meta`
- `curl -fsS https://api-v1.<domain>/v1/health`

## Onboarding Defaults
1. Create account via `POST /v1/control/onboard`.
2. Verify account policy is `POSTPAID`.
3. Verify credit summary is wallet/reserved/available = `0`.

## V2 Credit Lifecycle
1. Grant credits.
2. Reserve (expect ACTIVE reservation and reduced available balance).
3. Consume (expect reservation `CONSUMED`).
4. Reserve again and release (expect reservation `RELEASED`).
5. Run reconciliation dry-run (`POST /v1/control/credits/reconcile` with `dry_run=true`).

## Subscription Refill
1. Create subscription plan + subscription (`POST /v1/control/subscriptions`).
2. Trigger manual refill (`POST /v1/control/subscriptions/:id/refill`).
3. Retry with same idempotency key and confirm no second credit grant.
4. Verify `next_refill_at` moved forward and subscription event was recorded.

## Postpaid Service Invoice (V2)
1. Create draft invoice (`POST /v1/service-invoices`).
2. Issue invoice (`POST /v1/service-invoices/:id/issue`).
3. Mark paid (`POST /v1/service-invoices/:id/mark-paid`).
4. Retry mark-paid with same idempotency key and confirm no duplicate payment row.
5. Upload payment proof metadata (`POST /v1/service-invoices/:id/payment-proof`).

## Security and Isolation
- Confirm tenant token can read only `/v1/billing/subscription` and `/v1/billing/credits/summary` for its own tenant.
- Confirm tenant token cannot call `/v1/control/*`.
- Confirm webhook endpoints reject invalid signatures when `PAYMENT_WEBHOOK_DEV_BYPASS=false`.

## V1 Handshake
- Verify V1 UI shows billing mode + available credits from Studio.
- Verify V1 can still run postpaid invoice flow.
- Verify V1 emits billing timeline events visible in V2 Studio timeline.
