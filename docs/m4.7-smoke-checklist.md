# M4.7 Smoke Checklist (V1 + V2 Billing Spine)

## Preconditions

- V1 API deployed and reachable (`/v1/meta` returns `app=zenops-v1`)
- V2 API deployed and reachable (`/v1/meta` returns `app=zenops-v2`)
- V1 and V2 are on separate Postgres instances/volumes
- V1 has `STUDIO_BASE_URL` and `STUDIO_SERVICE_TOKEN` configured

## Flow A: POSTPAID Path

1. In V2 Studio, create/find an external associate account.
2. Set billing policy to `POSTPAID`.
3. Submit a commission request from portal.
4. Approve/accept request (V1 or V2 flow), ensure invoice is created.
5. Confirm invoice is visible (status `DRAFT/ISSUED/SENT`).
6. Record payment.
7. Verify invoice transitions to `PAID`.
8. Verify deliverables become accessible only after payment.
9. Verify V2 received V1 billing events (`invoice_created`, `invoice_issued/sent`, `payment_recorded`, `invoice_paid`).

## Flow B: CREDIT Path

1. In V2 Studio, set account billing policy to `CREDIT`.
2. Submit and accept a commissioned request.
3. Verify credit reservation is created (`reserve` event / reservation active).
4. Release deliverable.
5. Verify credit reservation is consumed.
6. Cancel a work item before completion and verify reservation is released (where applicable).

## Security / Boundary Checks

1. Call Studio control endpoint with tenant/portal token -> must fail.
2. Call billing service endpoint without service token -> must fail.
3. Call billing service endpoint with wrong service token -> must fail.
4. Ensure portal cannot access `/v1/control/*`.

## Identity Guard Checks

1. Run scripts that resolve base URL and probe `/v1/meta`.
2. Confirm scripts fail closed if target app identity does not match expected app.
