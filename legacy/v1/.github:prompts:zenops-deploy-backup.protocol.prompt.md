---
agent: "agent"
description: "Implement Zen Ops safe update protocol + backups + Google Drive offsite via rclone"
---

## Mission
Implement a production-safe update protocol for Zen Ops on a single VPS/KVM using Docker Compose:
- DB must never be disturbed (named volume never deleted/recreated)
- Deployments must be repeatable and rollback-friendly
- Backups must be nightly and pushed to Google Drive using rclone (headless auth supported)

## First: Discover current repo structure (DO THIS BEFORE WRITING CODE)
1) Inspect existing compose files (docker-compose.yml and any prod override).
2) Identify services: api, web/frontend, reverse proxy, db, email-worker (and any others).
3) Identify current env files and DB connection env vars.
4) Confirm Alembic command and app entrypoints.
5) Confirm upload paths/volumes already used.

Output a short "Current State" summary with file paths and service names.

## Required deliverables (must implement)
### A) Production-safe deploy scripts
Create:
- ops/deploy.sh
- ops/backup.sh
- ops/restore.sh (even if partially manual, must be documented)

Hard rules in scripts:
- NEVER call `docker compose down -v`
- Always run a DB backup BEFORE migrations
- Run migrations as a one-off task (not automatic on api start)
- Use versioned image tags (accept TAG as an input)
- Include healthcheck and smoke test steps

### B) Compose additions (prefer prod overlay)
Add either:
- docker-compose.prod.yml overlay, OR clearly scoped changes to existing compose.

Must include:
1) `migrate` one-off service:
   - uses api image
   - command: `alembic upgrade head`
2) `backup` one-off service:
   - uses postgres image or a tiny utility image with pg_dump + rclone
   - writes `pg_dump -Fc` dumps to a mounted backups volume
   - pushes dump to Google Drive via rclone remote
3) Named volumes:
   - `pgdata` (existing) for Postgres
   - `backups` for local dump retention
   - `rclone_config` to persist rclone.conf

### C) Backup policy
Implement:
- nightly pg_dump in custom format (-Fc)
- retention: keep 14–30 days locally (default 14) and 30 days in Drive (configurable)

### D) Google Drive via rclone (headless)
Provide:
- documented rclone setup steps for headless authorization
- store rclone config in `rclone_config` volume
- default remote path: `gdrive:ZenOpsBackups/<env>/`

Optional but recommended:
- rclone crypt remote for encrypted backups

### E) Runbook
Create:
- docs/DEPLOYMENT_RUNBOOK.md

Must include:
- standard deploy steps: pull → backup → migrate → up → healthcheck → smoke tests
- rollback steps:
  - rollback app by redeploying previous image tag
  - rollback DB by restoring a dump into a fresh DB container (document carefully)
- restore drill instructions (how to test restore monthly/quarterly)

## Verification steps (must include in output)
- Commands to:
  - run a manual backup now
  - run migrate now
  - deploy with TAG=...
  - verify /readyz endpoint
  - list backups locally + in Drive
  - perform a restore into a test DB container (non-destructive)

## Constraints
- Keep it simple: single VPS, docker compose, reverse proxy already exists.
- Do not introduce Kubernetes/Swarm.
- Do not change DB volume behavior; no destructive migration steps.
- Use bash strict mode and clear logging.

## Context files to open/reference
Ask me to open these files in VS Code if you can’t access them:
- docker-compose.yml (+ any prod overrides)
- backend alembic config / migration entry point
- .env.example / .env.production template
- reverse proxy config (Caddyfile/nginx)